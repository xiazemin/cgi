# CGI的工作原理

一、CGI技术



1.1 CGI的提出



　　CGI是外部扩展应用程序与WWW服务器交互的一个标准接口。按照CGI标准编写的外部扩展应用程序可以处理客户端（一般是WWW浏览器）输入的协同工作数据，完成客户端与服务器的交互操作。这在实际应用中非常有用，如可以编写CGI外部扩展程序来访问外部数据库，客户端用户可以通过它和WWW服务器来进行数据查询。CGI一般分两种：标准CGI和缓冲CGI。所有的WWW服务器均应支持标准CGI，按标准CGI编写的程序与具体的WWW服务器无关。而按缓冲CGI编写的程序与WWW服务器有关。



1.2 CGI的工作原理



　　1．标准CGI



　　客户端、服务器、CGI接口与外部程序间的关系可用图1－1表示（编排者：图略）：如上图所示，服务器是客户端（如浏览器）与扩展程序之间的通道。当客户端的用户完成了一定输入工作（比如填充完HTML文档中的FORM表）之后向服务器发出HTTP请求（称为CGI请求），服务器守护进程接收到该请求后，就创建一个子进程（称为CGI进程）。该CGI子进程将CGI请求的有关数据设置成环境变量，在外部CGI程序与服务器间建立两条数据通道（标准I／O），然后启动URL指定的CGI程序，并与该子进程保持同步，以监测CGI程序的执行状态。子进程通过标准输出流将处理结果传递给服务器守护进程，守护进程再将处理结果作为应答消息回送到客户端。外部CGI程序通过环境变量、命令行参数、标准输入输出与WWW服务器进行通讯，传递有关参数和处理结果。

＊环境变量：当服务器守护进程创建子进程运行CGI程序时，设置相应的环境变量和命令行参数，以传递客户端和服务器的有关信息给该子进程。

＊命令行参数：命令行参数仅在有HTML文档中有SINDEX查询的情况下使用。

＊标准输入输出：当HTTP请求模式采用POST方式时，CGI程序通过标准输入流和有关环境变量来获取客户端传输数据；如采用GET方式时，CGI程序直接通过环境变量获取客户端传输数据。当CGI程序要返回处理结果（一般为HTML文档）给客户端时，它通过标准输出流将该结果数据传递给服务器守护进程。



　　2．缓冲CGI



　　标准CGI使用Stdin／Stdout来进行数据通讯，这是由其最初开发环境（Unix操作系统）所决定的。但是许多Windows环境下的编程工具（如VB和Delphi等）是不支持这种I／O方式的，这时就不能用它们来开发基于标准CGI的应用程序。于是有些服务器提出了缓冲CGI的概念。缓冲CGI亦称为WinCGI。此时CGI扩展程序与服务器间通过缓冲CGI而不是标准CGI进行通讯，而缓冲CGI与服务器间的通讯还是通过标准CGI接口。后者由WWW服务器的内置缓冲处理程序实现。这几部分的关系可用图1－2表示（编排者：图略）：缓冲CGI的工作原理与标准CGI相似，不同的是当服务器守护进程接收到客户端的CGI请求时，所建立的CGI子进程将CGI请求的有关数据设置成环境变量外，还将它们保存在输入缓冲区中；通过缓冲处理程序在外部CGI程序与服务器间建立两条数据通道（输入／输出缓冲区）。CGI子进程通过输出缓冲区将处理结果传递给服务器守护进程。此处外部CGI程序通过环境变量和输入／输出缓冲区与WWW服务器进行通讯，传递有关参数和处理结果。此处环境变量的意义同上，不过这些环境变量及其相应值保存在输入缓冲区中。此外，输入缓冲区中还存放客户端的传输数据（如采用POST模式的话）。输出缓冲区用来存放扩展程序的处理结果。



　　3．标准CGI与缓冲CGI的区别



　　对CGI扩展程序而言，最主要差别在于数据的I／O不同：对缓冲CGI，服务器与CGI扩展程序间的数据交换是通过缓冲区；而标准CGI是通过标准I／O。使用缓冲CGI可选择更多的开发工具，可以开发Windows95和WindowsNT下的GUI扩展程序；而使用标准CGI所选用的开发工具必须支持标准I／O。只有少数几种WWW服务器支持缓冲CGI，因此基于它的扩展程序兼容性不如标准CGI好。



1．3 CGI与其他WWW技术的关系



　　CGI作为WWW服务器的标准扩展技术，由上面CGI的基本原理可知，它和许多其它的WWW技术密切相关，如HTTP、HTML、MIME和URL等，下面主要就它与前两种技术的关系进行研究。



　　1．CGI与HTTP协议



　　CGI通过HTTP协议在客户端和服务端进行通讯：＊客户端用户代理向服务器发送的请求是HTTP请求消息。该消息中含有处理用户输入的CGI扩展程序的URL值。＊CGI扩展程序在处理结束后，返回给客户端的应答是HTTP应答消息。因此CGI程序的输出数据必须符合HTTP应答消息的语法格式，这在基于CGI标准的开发中非常重要。



　　2．CGI与HTML语言



　　CGI扩展程序的输出数据（HTTP应答消息）一般有两种：符合MIME类型的文档（最普遍的是HTML文档，表示为text/html）；指向其它文档的URL链接。这两种方式都与HTML语言有关，数据的组织须符合HTML语法格式。



1．4 CGI开发的几个问题



　　基于WWW的人机交互一般有两种情况：本地交互和通过网络传输的交互。前者是指客户端用户的输入数据在客户端本地进行处理，然后将处理结果返回给用户，常见的开发工具有JavaScript（Netscape开发）和VBScript（Microsoft开发）；后者是指客户端用户输入的数据通过网络传输到WWW服务器，服务器处理结束后将处理结果返回给客户端用户，常见的开发技术是WWW服务器扩展技术（如CGI，API等）。此处主要讨论基于标准CGI技术的通过网络进行数据传输的交互实现。对这种人机交互的实现，主要有三个环节需要解决：如何获取客户端传输的数据，如何提取有效数据并处理这些数据，如何向客户端返回应答。下面分别结合有关技术，谈谈这三方面问题的解决。



　　1．客户端传输数据的获取



　　由第三章CGI的原理可知，当服务端守护进程接收到客户端用户代理（如浏览器）提交的CGI请求时，所创建的CGI子进程会设置与CGI请求内容有关的环境变量，并建立服务器与外部CGI程序之间通讯的通道（即标准I／O）。CGI程序可以通过环境变量，标准I／O或命令行参数获取客户端用户输入的数据。数据的获取与请求所采用的HTTP方法（Method）和用户所使用的请求方式有关。用户通过CGI请求数据一般有三种方式：HTMLFORM表，ISINDEX，可点击图片（ISMAP或Imagemaps）。后两种方式是通过命令行参数传递用户的输入数据；在C语言中（下面的举例亦然），CGI程序可以用argc和argv［int］获得这些参数值。而前一种方式则取决于HTTP请求方法；但不管采用何种方法，都将用到环境变量来传递有关请求内容。



　　●获取环境变量环境变量的类别很多，包含客户端和服务端的详细信息。在一般CGI程序开发中，下述几个环境变量在数据传递中起着重要作用。



　　　＊GATEWAY—INTERFACE



　　CGI程序所使用的CGI标准接口的版本号。如使用的CGI1．1版，该变量表示为“CGI/1.1”



　　　＊REQUEST—METHOD 　　HTTP请求方法。根据该变量值可判断CGI请求所采用的请求方法，以决定是通过Stdin还是通过环境变量QUERY—STRING获取客户端传输数据。



　　　＊QUERY—STRING



　　QUERY—STRING是CGI程序URL中“?”之后的数据。当使用ISINDEX查询或FORM表使用GET方法时，客户端传输数据可以通过读取该变量而获得。



　　　＊CONTENT—LENGTH



　　CONTENT—LENGTH表示客户端传输数据的字节数。



　　　＊CONTENT—TYPE



　　CONTENT—TYPE表示客户端传输数据的数据编码类型。利用— environ\(int\)函数可以获得所有的环境变量及其值；利用getenv\(constchar\*\)函数可以获得指定环境变量的相应值。



　　●HTTP请求方法



　　客户端用户代理提交的CGI请求是HTTP请求，其中包括HTTP请求方法。HTTP协议定义的请求方法中常用的主要有GET和POST。客户端FORM表的METHOD属性用来设置请求方法，其缺省值为GET。如果在FORM中使用GET方法，CGI程序通过环境变量QUERY—STRING获取客户端传输数据。如果在FORM中使用POST方法，CGI程序通过通过CONTENT—LENGTH获取客户端传输数据的字节数，通过Stdin读取客户端传输数据。



　　2．有效数据的提取和处理



　　通过上述方式获取的客户端传输数据的一般格式为：



　　name\[1\]=value\[1\]&name\[2\]=value\[2\]&...name=value...name\[n\]=value\[n\]



　　其中name［i］表示变量名，它是在FORM表中某输入域的名字；value［i］表示变量值，它是用户在FORM表中某输入域中输入的值。客户端传输数据的每对″name=value″串由′&′字符分隔，其数据编码类型可以从环境变量CONTENT—TYPE获取。CGI/1.1版仅支持“application/x-www-form-urlencoded”编码方式。这种编码方式和URL的编码方式一样，遵循两个规则：数据中的空格（ASCII码值32）编码成′+′号；保留字符编码成″%xx″形式，″XX″是该字符ASCII值的十六进制表示，比如″$″的编码为″%24″，″?″的编码为″%3F″。因此，要获取客户端用户的输入数据，必须对上述获取的数据进行分离和解码等处理。利用函数strtok\(\)、strchr\(\)等可以实现数据分离处理，而数据的解码则需要对整个数据串进行扫描，将数据串中的″%xx″复原为对应的ASCII码。在提取到有效数据后，还可能进行许多其他的处理，如数据库查询等。这种处理与普通编程相同。



　　3．向客户端返回应答



　　CGI程序处理结束后，通过标准输出流将应答信息传递给服务器，再由服务器返回给发出请求的客户端。其输出的应答信息是HTTP应答消息，它一般由两部分组成：应答头和应答数据。常见的应答头包括三种头域：Content—Type（数据编码类型，用MIME类型表示），Location（特定文档的URL，这种情况不直接向客户端输出内容而输出该URL）和Status（处理结果的状态码和状态描述）。HTTP应答头由几行格式相同的文本构成，每行的基本格式为：″头域名：该域内容″。应答头和应答体之间用一空行加LF（或CR／LF）分隔。应答体为CGI扩展程序的输出数据，其数据类型应该与Content—Type值相一致。CGI程序的输出可以用printf（）、puts（）等标准I／O函数来实现。



　　4．CGI程序的开发及其一般流程



　　在开发CGI程序过程中，可根据实际情况（服务器提供的接口、实际需求和程序员经验等）选择编程语言，如C／C＋＋，Perl，TCL，AnyUnixshell，VB，AppleScript。如果选用C／C＋＋等语言，必须编译成可执行文件；如果选用Perl等解释语言，服务器必须安装相应的解释器。

